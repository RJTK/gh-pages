<!DOCTYPE html>
<html lang="en-us" class="lang-en-us">
    <head><meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Solving puzzles with computers.
" />
<meta itemprop="description" content="Solving puzzles with computers.
" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<meta itemprop="name" content="Constraint Programming, Puzzles, ILP, and z3 - Quant Out of Water" />
<link href="https://rjtk.github.io/index.xml" title="Constraint Programming, Puzzles, ILP, and z3 - Quant Out of Water" type="application/rss+xml" rel="alternate" />
<title>Constraint Programming, Puzzles, ILP, and z3 - Quant Out of Water</title><link rel="stylesheet" href="/main.1fcc545d2ef04212761e07c486eaac8b9c8e1c46af8fc344804b7383bb9116bc.css" integrity="sha256-H8xUXS7wQhJ2HgfEhuqsi5yOHEavj8NEgEtzg7uRFrw=" /><meta property="og:site_name" content="Constraint Programming, Puzzles, ILP, and z3 - Quant Out of Water" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Constraint Programming, Puzzles, ILP, and z3" />
<meta property="og:description" content="Solving puzzles with computers.
" />
<meta property="og:url" content="https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/" /><meta property="article:publisher" content="https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/" /><meta property="article:published_time" content="2023-09-24T00:00:00-07:00" /><meta property="article:modified_time" content="2023-09-25T23:55:16-07:00" /><meta name="theme-color" content="#dd6065" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Constraint Programming, Puzzles, ILP, and z3 - Quant Out of Water" />
<meta name="apple-mobile-web-app-status-bar-style" content="white" />

<meta name="twitter:card" content="summary_large_image" /><meta name="twitter:title" content="Constraint Programming, Puzzles, ILP, and z3 - Quant Out of Water" />
<meta name="twitter:description" content="Solving puzzles with computers.
" />
<meta name="twitter:url" content="https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" /><link rel="manifest" href="/manifest.json" /><link href="/icon.png" rel="shortcut icon" />
<link href="/icon.png" rel="Bookmark" />
<link rel="apple-touch-icon" href="/icon.png" /><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Constraint Programming, Puzzles, ILP, and z3",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/rjtk.github.io\/posts\/constraint-programming-puzzles-ilp-and-z3\/"
  },"genre": "posts","wordcount": 6179 ,
  "url": "https:\/\/rjtk.github.io\/posts\/constraint-programming-puzzles-ilp-and-z3\/","datePublished": "2023-09-24T00:00:00-07:00","dateModified": "2023-09-25T23:55:16-07:00","author": {
    "@type": "Person",
    "name": "qoow"
  },"description": ""
}
</script>


    </head>

    <body class="dark:bg-darkBg dark:text-darkText">
        <div class="relative mx-auto shadow-lg md:max-w-4xl xl:max-w-4xl 2xl:max-w-4xl">
            <div class="main flex flex-col justify-between bg-white dark:bg-darkFg"><header
    class="relative"
><div class=" border-b py-6 text-center dark:border-darkBorder"><div class="text-3xl">Quant Out of Water</div></div><nav id="nav" class="navbar top-0 z-10 flex items-center border-b px-5 py-6 dark:border-darkBorder md:px-10">
            <div class="route-items flex w-full items-center justify-around"><a
                        title="Home"
                        data-active-link="/"
                        href="/"
                        class=" relative flex cursor-pointer flex-col items-center text-gray-700 transition duration-150 ease-[ease]"
                    >
                        <i
                            class="eva eva-home flex h-8 w-8 items-center justify-center text-3xl leading-none text-gray-500 transition duration-150 ease-[ease] dark:text-darkTextPlaceholder"
                        ></i>
                        <span class="mt-1 block text-xs text-gray-400 dark:text-darkText sm:text-sm md:hidden">Home</span>
                    </a><a
                        title="About"
                        data-active-link="/about/"
                        href="/about/"
                        class=" relative flex cursor-pointer flex-col items-center text-gray-700 transition duration-150 ease-[ease]"
                    >
                        <i
                            class="eva eva-people flex h-8 w-8 items-center justify-center text-3xl leading-none text-gray-500 transition duration-150 ease-[ease] dark:text-darkTextPlaceholder"
                        ></i>
                        <span class="mt-1 block text-xs text-gray-400 dark:text-darkText sm:text-sm md:hidden">About</span>
                    </a>
            </div>
        </nav><nav class="sub-navbar z-10 flex items-center border-b px-5 py-2 dark:border-darkBorder md:px-10"><a
                    title="Tags"
                    data-active-link="/tags/"
                    href="/tags/"
                    class=" relative mr-4 flex cursor-pointer items-center text-gray-400 transition duration-150 ease-[ease] hover:text-theme dark:text-darkText"
                >
                    <i class="eva eva-pricetags mr-1 leading-none"></i>
                    <span>Tags</span>
                </a></nav><div class="dark-mode-switch absolute right-0 top-0 z-10 cursor-pointer pr-2 pt-2 text-xl leading-none">
    <i class="eva eva-moon opacity-20 dark:opacity-70"></i>
</div>
</header>
<main class=" relative flex flex-grow" id="swup"><style>:root {
        --font:Roboto, "Helvetica Neue", Helvetica, Arial, sans-serif;
    }</style>
<div class="type-posts layout- w-full"><div class="relative h-full">
    <div class="relative h-full">
        <div class="page-view-article flex h-full flex-col bg-white dark:bg-darkFg"><div class="relative"><div
    style="background-image: linear-gradient(180deg,#f2f2f2, #ccc);padding-bottom:75%;"
    class="article-cover h-0Page(/posts/constraintProgramming/index.md) relative w-full"
>
    <picture class="noscript-hidden"><source data-srcset="/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading_hub9f01da8d8580c77bb2b5c2099611a3c_53449_693x0_resize_q95_h2_catmullrom_3.webp 1080w" type="image/webp" /><img
            data-src="https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading.png"
            src="/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading_hub9f01da8d8580c77bb2b5c2099611a3c_53449_8dba20af959d9246c9d206fb809a529c.jpg"
            width="693"
            height="615"
            data-srcset="/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading_hub9f01da8d8580c77bb2b5c2099611a3c_53449_693x0_resize_catmullrom_3.png 1080w"
            alt="Constraint Programming, Puzzles, ILP, and z3"
            class="absolute left-0 top-0 h-full w-full object-cover object-center"
            data-lazyload data-lazyload-blur

        />
    </picture>
    <noscript>
        <picture><source srcset="/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading_hub9f01da8d8580c77bb2b5c2099611a3c_53449_693x0_resize_q95_h2_catmullrom_3.webp 1080w" type="image/webp" /><img
                src="https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading.png"
                srcset="/posts/constraint-programming-puzzles-ilp-and-z3/2474_puzzle_heading_hub9f01da8d8580c77bb2b5c2099611a3c_53449_693x0_resize_catmullrom_3.png 1080w"
                alt="Constraint Programming, Puzzles, ILP, and z3"width="693"
                height="615"
                class="absolute left-0 top-0 h-full w-full object-cover object-center"
            />
        </picture>
    </noscript>
</div>
<h1 class="article-title absolute bottom-0 left-0 w-full px-6 pb-8 pt-32 text-3xl text-white dark:text-darkText md:px-10 md:text-4xl">
    Constraint Programming, Puzzles, ILP, and z3
</h1>
</div>
<div class="article-info border-b p-6 pb-3 text-sm dark:border-darkBorder md:px-10">
    <div>
        <div class="mb-3 mr-4 inline-flex items-center sm:rounded-full">
            <i class="eva eva-clock-outline mr-1"></i>
            <span>
                <time
                    title="Published in 24 Sep 2023 00:00:00"datetime="2023-09-24T00:00:00-07:00">24 Sep 2023</time
                >
            </span>
        </div><span class="mb-3 mr-4 inline-flex items-center sm:rounded-full">
                    <i class="eva eva-edit-2-outline mr-1"></i>
                    <span>
                        <time
                            title="Last modified on: 25 Sep 2023 23:55:16"datetime="2023-09-25T23:55:16-07:00">25 Sep 2023</time
                        >
                    </span>
                </span><div class="mb-3 mr-4 inline-flex items-center sm:rounded-full">
                <i class="eva eva-flag-outline mr-1"></i>
                <span>30 mins read</span>
            </div><div class="mb-3 mr-4 inline-flex items-center sm:rounded-full">
                <i class="eva eva-bar-chart-outline mr-1"></i>
                <span>6179 words</span>
            </div></div></div>
<aside
            class="toc border-b border-gray-300 px-5 py-5 dark:border-darkBorder md:px-10 2xl:fixed 2xl:top-10 2xl:m-0 2xl:-ml-72 2xl:w-72 2xl:border-none 2xl:p-0 2xl:py-4 2xl:pr-4 "
        >
            <header>
                <h1 class="mb-3 text-2xl font-bold 2xl:mb-4">Table of Contents</h1>
            </header>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#constraint-programming">Constraint Programming</a>
      <ul>
        <li><a href="#integer-linear-programming">Integer Linear Programming</a></li>
        <li><a href="#satisfiability-modulo-theories">Satisfiability Modulo Theories</a></li>
      </ul>
    </li>
    <li><a href="#solving-the-vanilla-24-7-puzzle">Solving the Vanilla 24-7 Puzzle</a></li>
    <li><a href="#solving-the-4-in-1-puzzle">Solving the 4-in-1 Puzzle</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
        </aside><section class="article-content typo relative flex-grow px-6 py-5 md:px-10"><i title="Faster Reads" id="bionicReading" class="absolute right-0 top-0 cursor-pointer p-3"
            ><svg class="w-4 h-4 fill-current text-gray-400" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10811" ><path d="M480 192c-19.2 0-32-12.8-32-32v-128c0-19.2 12.8-32 32-32s32 12.8 32 32v128c0 19.2-12.8 32-32 32zM160 1024c-6.4 0-19.2 0-25.6-6.4l-128-128c0-6.4-6.4-19.2-6.4-25.6s6.4-19.2 6.4-25.6l512-512c12.8-6.4 38.4-6.4 51.2 0l128 128c0 6.4 6.4 19.2 6.4 25.6s-6.4 19.2-6.4 25.6l-512 512c-6.4 6.4-19.2 6.4-25.6 6.4z m-83.2-160l83.2 83.2 467.2-467.2-83.2-83.2-467.2 467.2zM992 576h-128c-19.2 0-32-12.8-32-32s12.8-32 32-32h128c19.2 0 32 12.8 32 32s-12.8 32-32 32zM768 288c-6.4 0-19.2 0-25.6-6.4-12.8-12.8-12.8-32 0-44.8l96-96c12.8-12.8 32-12.8 44.8 0s12.8 32 0 44.8l-96 96c0 6.4-12.8 6.4-19.2 6.4zM256 288c-6.4 0-19.2 0-25.6-6.4L134.4 185.6c-6.4-12.8-6.4-38.4 0-51.2s32-12.8 44.8 0l96 96c12.8 12.8 12.8 32 0 44.8 0 12.8-12.8 12.8-19.2 12.8zM864 896c-6.4 0-19.2 0-25.6-6.4l-96-96c-12.8-12.8-12.8-32 0-44.8s32-12.8 44.8 0l96 96c12.8 12.8 12.8 32 0 44.8 0 6.4-12.8 6.4-19.2 6.4z" p-id="10812"></path><path d="M544 640c-6.4 0-19.2 0-25.6-6.4l-128-128c-6.4-12.8-6.4-38.4 0-51.2s32-12.8 44.8 0l128 128c12.8 12.8 12.8 38.4 6.4 51.2-6.4 6.4-19.2 6.4-25.6 6.4z" p-id="10813"></path></svg></i
        ><p>Solving puzzles with computers.</p>
<figure><img src="2474_puzzle_heading.png"/>
</figure>

<h2 class="group " id="introduction"
    >Introduction<a href="#introduction"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h2>

<p>Earlier in the year I stumbled upon a puzzle posted by Jane Street called the <a
    class="link"
    href="https://www.janestreet.com/puzzles/twenty-four-seven-four-in-one-index/"target="_blank" rel="noopener">4-in-1 24-7 puzzle</a
>
.  The puzzle is in the front matter of this post.  On a first look, and on first reading through the rules for the puzzle, it appears cartoonishly complicated.  But, if you&rsquo;d like to take your own crack at the problem, there is a simpler <a
    class="link"
    href="https://www.janestreet.com/puzzles/twenty-four-seven-index/"target="_blank" rel="noopener">24-7 puzzle</a
>
 which can be solved first (as I did), before tackling the 4-in-1 version.</p>
<p>I&rsquo;m not sure if the creators of the puzzle imagined people would print the puzzle onto paper and solve it by hand, but I immediately thought to myself: I am <strong>way</strong> too lazy for that.  So instead I naturally wanted to get a computer to do all the work for me&hellip;</p>
<p>Throughout my short academic career, I generally took much more interest in continuous optimization than I did in discrete optimization.  Almost everything I learned about discrete optimization I learned ages ago from <a
    class="link"
    href="https://www.coursera.org/learn/discrete-optimization"target="_blank" rel="noopener">this Coursera course</a
>
, and the application of semidefinite programming to <a
    class="link"
    href="https://www.cs.cmu.edu/~anupamg/adv-approx/lecture14.pdf"target="_blank" rel="noopener">approximating MAXCUT</a
>
.  That being said, I knew that constraint programming was a natural approach to solving puzzles, the 24-7 puzzles being no exception.</p>
<p>Interestingly, I&rsquo;m no stranger to algorithmic puzzle-solving.  Many years ago, my girlfriend showed me an optical illusion puzzle that involved fitting a 4x4 grid of tiles with matching patterns on adjacent edges &ndash; you had to figure out how to place the tiles so that the patterns on the edges all matched.</p>
<figure><img src="illusion_puzzle.png"
         alt="Figure 1: Ruining the fun of this puzzle with a computer"/><figcaption>
            <p><span class="figure-number">Figure 1: </span>Ruining the fun of this puzzle with a computer</p>
        </figcaption>
</figure>

<p>I wrote a simple <kbd>C++</kbd> program to basically brute force this puzzle &ndash; I remember running it for about a day on my ancient laptop.  Armed with the tools described in this blog post, it could probably be solved in under a second, and the modeling and implementation could be done in a couple hours (rather than the whole weekend, as the <kbd>C++</kbd> program probably took me).</p>


<h2 class="group " id="constraint-programming"
    >Constraint Programming<a href="#constraint-programming"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h2>

<p><em>Constraint programming</em> is an algorithmic methodology that targets problems that have a discrete solution space, such as arranging puzzle pieces, rather than continuous problems like optimizing the shape of an aluminum can.  Moreover, in contrast to optimization, the focus is upon simply <em>finding</em> a feasible solution that satisfies a given set of constraints, rather than optimizing an objective function <em>subject to</em> those constraints.</p>
<p>The approach involves systematically enumerating constraints that a solution must meet and which, if met, constitute a solution. A search algorithm then explores the solution space and either successfully returns a solution, or proves that one does not exist.</p>
<p>An example of how constraint programming might be used is in solving Sudoku puzzles.  For instance, a common technique involves initially considering all numbers from 1 to 9 as candidates for each square. You then iteratively narrow down these options based on existing numbers in the grid, filling in a square when only one candidate remains and backtracking when no candidates are left.  The process of checking how a decision affects the constraints is called <em>constraint propagation</em> and it is one particular algorithmic building block for trying to tackle <em>constraint programming</em> problems.</p>
<p>I followed a strategy like this to <a
    class="link"
    href="https://github.com/RJTK/sodoku"target="_blank" rel="noopener">hack together a Sudoku solver</a
>
, similarly inspired when I saw my girlfriend working on a book of Sudoku puzzles&hellip; <em>Perhaps this is a theme</em> 🤔 &hellip; At the time I was rather satisfied to have been able to solve Sudokus in a couple hundred milliseconds (so slow largely because of a rather inefficient representation, and writing it in Python), though there are some <a
    class="link"
    href="https://t-dillon.github.io/tdoku/"target="_blank" rel="noopener">rather fast</a
>
 programs that can solve Sudoku on the order of microseconds.</p>
<p>These examples are ad-hoc, but I am more interested in general approaches.  Similarly to how <a
    class="link"
    href="https://www.cvxpy.org/"target="_blank" rel="noopener">CVX</a
>
 makes it incredibly easy to experiment with convex optimization problems, there are general modeling tools that can be used to model and solve whole classes of discrete optimization problems.  Indeed, if the constraints can be appropriately described, general purpose algorithms can be applied to search for feasible solutions.</p>
<p>For the rest of this post, I will describe two such general tools: <em>Integer Linear Programming</em>, and <em>Satisfiability Modulo Theories</em>, and how they can be used to solve constraint programming problems.</p>


<h3 class="group " id="integer-linear-programming"
    >Integer Linear Programming<a href="#integer-linear-programming"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h3>

<p>A concrete and practical means of describing constraint programs is by means of <em>integer linear programming</em> (ILP).  Specifically, a <em>feasibility</em> ILP:</p>
<p>\begin{equation}
\begin{aligned}
\text{find}&amp;\ x\\
\text{such that}
&amp;\ Ax \le b\\
&amp;\ x_i \in \mathbb{N}_0.
\end{aligned}\notag
\end{equation}</p>
<p>This looks a lot like an ordinary linear program \(\text{min}\{c^{\mathsf{T}} x\ |\ Ax \le b, x \in \mathbb{R}^n\}\) except there is no objective (practically speaking, just set \(c = 0\)) and there is an <em>integer constraint</em> \(x_i \in \mathbb{N}_0\).  That is, each element of the solution vector \(x\) must be an integer (including zero): \(0, 1, 2, \ldots\)</p>
<p>While linear programming problems are convex optimization problems, and thus entirely tractable, ILPs are NP-complete.  Theoretically, there is no known &ldquo;fast&rdquo; algorithm for solving ILPs in general, but practically speaking, we can usually still find optimal solutions (or good suboptimal approximations) fast enough for it to be useful.</p>
<p><kbd><strong>Remark</strong> (Totally Unimodular Matrices): If the matrix</kbd> \(A\) <kbd>in the ILP constraints is &ldquo;totally unimodular&rdquo;, then the LP solution and the ILP solution coincide.</kbd> <a
    class="link"
    href="https://courses.engr.illinois.edu/cs598csc/sp2010/Lectures/Lecture4.pdf"target="_blank" rel="noopener">This is an important and tractable special case</a
>
.</p>
<p>Another special case of ILP is what one might call <em>Boolean Linear Programming</em> (BLP), but is usually actually referred to as \(0-1\) linear programming.  In this case, we have the constraint \(x_i \in \{0, 1\}\) (equivalent to just including the constraint \(x_i \le 1\) in the ILP).  To give a sense of how powerful ILP is, the reader is encouraged to think about why the following constraints encode logical operators as BLP constraints:</p>
<ul>
<li>logical-and: \(z = x \wedge y\) is encoded as \(z \ge x + y - 1, z \le x, z \le y\).</li>
<li>logical-not: \(z = \neg x\) is encoded as \(z = 1 - x\)</li>
</ul>
<p>Given that we can encode <kbd>AND</kbd> and <kbd>NOT</kbd>, we can encode <em>any</em> Boolean expression &ndash; these operators together are universal.  Here&rsquo;s a couple more examples:</p>
<ul>
<li>logical-enforcement (if x then y): \(x \implies y\) is encoded as \(x \le y\)</li>
<li>logical-implication: \(z = (x \implies y) = y \vee \neg x\): is encoded as \(z \le (1 - x) + y, z \ge 1 - x, z \ge y\)
<ul>
<li>This looks complicated, but is nothing but the combination of logical-or and logical-not.</li>
</ul>
</li>
</ul>
<p>The reader is encouraged to try to encode some other logical expressions, e.g., exclusive-or, logical-or, <em>etc</em>.</p>
<p>I&rsquo;ll shortly use this modeling framework to encode and solve the (vanilla) 24-7 puzzle.</p>


<h3 class="group " id="satisfiability-modulo-theories"
    >Satisfiability Modulo Theories<a href="#satisfiability-modulo-theories"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h3>

<p>Similarly to ILP, <a
    class="link"
    href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories"target="_blank" rel="noopener">Satisfiability modulo theories</a
>
 (SMT) provide a means of implementing constraint programming.  SMT is a powerful methodology that generalizes <a
    class="link"
    href="https://en.wikipedia.org/wiki/Boolean_satisfiability_problem"target="_blank" rel="noopener">Boolean Satisfiability</a
>
 (SAT) to allow the inclusion of arithmetic (among other things) in the constraints.  For example, an instance of a SAT problem is to find a Boolean assignment to the variables \(x,y,z\) such that</p>
<p>\begin{equation}
\begin{aligned}
(x \vee \neg y \vee z) \wedge (y \vee \neg z)
\end{aligned}\notag
\end{equation}</p>
<p>evaluates to <kbd>True</kbd>, or prove that such an assignment does not exist.</p>
<p>An example of an SMT problem is to solve the (nonlinear!) system of inequalities</p>
<p>\begin{equation}
\begin{aligned}
x^2 + y^2 &amp;&gt; 3\\
x^3 + y &amp;&lt; 5
\end{aligned}\notag
\end{equation}</p>
<p>over the integers.  The inclusion of arithmetic makes SMT more general than SAT.</p>
<p>SAT and SMT both have rich mathematical theory surrounding them.  However, I am primarily interested in SMT as a practical engineering tool, so I admit to knowing almost nothing about the theory.  Indeed, I hardly know anything at all about theoretical computer science, and everything I&rsquo;ve learned about SMT so far comes from <a
    class="link"
    href="https://sat-smt.codes/SAT_SMT_by_example.pdf"target="_blank" rel="noopener">this very practical book</a
>
.  Computationally, a library for doing SMT programming is <a
    class="link"
    href="https://en.wikipedia.org/wiki/Z3_Theorem_Prover"target="_blank" rel="noopener">the z3 theorem prover</a
>
, which has <a
    class="link"
    href="https://ericpony.github.io/z3py-tutorial/guide-examples.htm"target="_blank" rel="noopener">convenient Python bindings</a
>
.  That same page has plenty of examples, as does <a
    class="link"
    href="https://theory.stanford.edu/~nikolaj/programmingz3.html"target="_blank" rel="noopener">this guide</a
>
.</p>
<p>Here&rsquo;s a quick example that solves the above nonlinear system:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> z3
</span></span><span style="display:flex;"><span>x <span style="color:#ff79c6">=</span> z3<span style="color:#ff79c6">.</span>Int(<span style="color:#f1fa8c">&#34;x&#34;</span>)
</span></span><span style="display:flex;"><span>y <span style="color:#ff79c6">=</span> z3<span style="color:#ff79c6">.</span>Int(<span style="color:#f1fa8c">&#34;y&#34;</span>)
</span></span><span style="display:flex;"><span>z3<span style="color:#ff79c6">.</span>solve(z3<span style="color:#ff79c6">.</span>And(
</span></span><span style="display:flex;"><span>    x<span style="color:#ff79c6">**</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">+</span> y<span style="color:#ff79c6">**</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">3</span>,
</span></span><span style="display:flex;"><span>    x<span style="color:#ff79c6">**</span><span style="color:#bd93f9">3</span> <span style="color:#ff79c6">+</span> y <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">5</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[x = -2, y = 0]
</span></span></code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ll shortly use <kbd>z3</kbd> to solve the complicated 4-in-1 24-7 puzzle.</p>


<h2 class="group " id="solving-the-vanilla-24-7-puzzle"
    >Solving the Vanilla 24-7 Puzzle<a href="#solving-the-vanilla-24-7-puzzle"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h2>

<p>Now the fun begins.  Here I&rsquo;m going to apply integer linear programming to solve the <a
    class="link"
    href="https://www.janestreet.com/puzzles/twenty-four-seven-index/"target="_blank" rel="noopener">&ldquo;vanilla&rdquo; 24-7 puzzle,</a
>
 which looks vaguely similar to a Sudoku:</p>
<figure><img src="247_puzzle.png"
         alt="Figure 2: Vanilla 24-7 Puzzle"/><figcaption>
            <p><span class="figure-number">Figure 2: </span>Vanilla 24-7 Puzzle</p>
        </figcaption>
</figure>

<p>The rules are described thus:</p>
<p><kbd>The grid is incomplete. Place numbers in some of the empty cells below so that in total the grid contains one 1, two 2’s, etc., up to seven 7’s. Furthermore, each row and column must contain exactly 4 numbers which sum to 20. Finally, the numbered cells must form a connected region, but every 2-by-2 subsquare in the completed grid must contain at least one empty cell.</kbd></p>
<p>Read this over a few times &ndash; the first couple of constraints sound straightforward, but the &ldquo;connected region&rdquo; constraint is difficult to even wrap one&rsquo;s head around.  It means that the cells which are filled in need to form a connected set &ndash; there are no &ldquo;islands&rdquo; of numbers.  We&rsquo;ll see these in detail as I show how they can be encoded as constraints in an ILP.</p>
<p>First, I am using <a
    class="link"
    href="https://developers.google.com/optimization"target="_blank" rel="noopener">ortools</a
>
, so let&rsquo;s do some setup:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> ortools.sat.python <span style="color:#ff79c6">import</span> cp_model
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> itertools <span style="color:#ff79c6">import</span> product
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>N <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>)  <span style="color:#6272a4"># Grid size</span>
</span></span><span style="display:flex;"><span>K <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">8</span>)  <span style="color:#6272a4"># Values</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff79c6">=</span> cp_model<span style="color:#ff79c6">.</span>CpModel()
</span></span><span style="display:flex;"><span>solver <span style="color:#ff79c6">=</span> cp_model<span style="color:#ff79c6">.</span>CpSolver()
</span></span></code></pre></td></tr></table>
</div>
</div><p>This sets up a Constraint Programming model called <kbd>model</kbd> and a <kbd>solver</kbd>.  We now just need to add our constraints!</p>
<p><kbd><strong>Remark</strong> (performance): I generally first write code that is readable and easy to debug and understand, only trying to optimize when it is necessary.  I&rsquo;m quite directly describing the constraints of the problem, and not trying to do anything clever.  I&rsquo;ve introduced a number of variables which I believe add clarity, but which may, technically, be redundant.  Fortunately, it is quite likely that the ILP solver is fairly capable of recognizing and eliminating obvious redundancies.  That being said, the way in which a program is encoded (in any modeling language) <em>can</em> potentially have a significant impact on performance, so it can be worth it to revise and refactor if one is not getting the throughput they need.</kbd></p>
<p><kbd><strong>Remark</strong> (modeling tip): While it may be counter intuitive, it is actually possible that <em>increasing</em> the number of constraints in the problem can actually <em>improve</em> performance.  The reason being that the search space is more constrained.</kbd></p>
<p>The first variable I&rsquo;m introducing is what I&rsquo;ve called a <kbd>panel</kbd>.  This is a \(7 \times 7 \times 7\) grid of \(\{0, 1\}\) indicators where <kbd>panel[k][i][j] = 1</kbd> if and only if the cell at position <kbd>(i, j)</kbd> is equal to <kbd>k</kbd>.   Let&rsquo;s first encode all the static assignments using this variable.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Declare variables which encode the values on the board as 7 sets of Boolean indicators</span>
</span></span><span style="display:flex;"><span>panel <span style="color:#ff79c6">=</span> {k: [[model<span style="color:#ff79c6">.</span>NewIntVar(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;z_</span><span style="color:#f1fa8c">{</span>k<span style="color:#f1fa8c">}{</span>i<span style="color:#f1fa8c">}{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> k <span style="color:#ff79c6">in</span> K}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Ensure that only one of the panel indicators is active</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(<span style="color:#8be9fd;font-style:italic">sum</span>(panel[k][i][j] <span style="color:#ff79c6">for</span> k <span style="color:#ff79c6">in</span> K) <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Manually encode the given values</span>
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">0</span>][<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">6</span>][<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">3</span>][<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">6</span>][<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">6</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">2</span>][<span style="color:#bd93f9">5</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">2</span>][<span style="color:#bd93f9">6</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">3</span>][<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">7</span>][<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">2</span>][<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">7</span>][<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(panel[<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">6</span>][<span style="color:#bd93f9">5</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The function <kbd>model.Add</kbd> adds a constraint to the ILP.</p>
<figure><img src="now_this_is_constraint_programming.jpg"/>
</figure>

<p>Notice that the constraint <kbd>sum(panel[k][i][j] for k in K) &lt;= 1</kbd>, along with the fact that <kbd>panel[k][i][j]</kbd> is either \(0\) or \(1\), ensures that just one of these indicators can be active at a time.</p>
<p>Another obvious variable to introduce is the <kbd>grid</kbd>, which is a \(7 \times 7\) array of variables equal to the value of that cell.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Variables that Store the value of the grid at position (i, j)</span>
</span></span><span style="display:flex;"><span>grid <span style="color:#ff79c6">=</span> [[model<span style="color:#ff79c6">.</span>NewIntVar(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">7</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;g_</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Encode the values of the grid from the zero-one variables</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(grid[i][j] <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">sum</span>(k <span style="color:#ff79c6">*</span> panel[k][i][j] <span style="color:#ff79c6">for</span> k <span style="color:#ff79c6">in</span> K))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since only one <kbd>panel</kbd> indicator can be active, <kbd>sum(k * panel[k][i][j] for k in K)</kbd> must be equal to the integer value that is being encoded.</p>
<p>This <kbd>grid</kbd> variable makes it easier to encode the row and column sum constraints.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Each row and column must sum to 20</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> row <span style="color:#ff79c6">in</span> N:
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(<span style="color:#8be9fd;font-style:italic">sum</span>(grid[row]) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">20</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> col <span style="color:#ff79c6">in</span> N:
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(<span style="color:#8be9fd;font-style:italic">sum</span>(grid[i][col] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">20</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>And, the reason I introduced the <kbd>panel</kbd> variable in the first place is because it makes is easy to encode the counting constraint:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># The grid must contain one 1, two 2s, three 3s, etc.</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> k <span style="color:#ff79c6">in</span> K:
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(<span style="color:#8be9fd;font-style:italic">sum</span>(<span style="color:#8be9fd;font-style:italic">sum</span>(panel[k][i][j] <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">==</span> k)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The constraint that each row and column contain exactly four non-zero numbers, and that each \(2 \times 2\) subsquare contain an empty cell is easy to encode if we introduce another <em>Boolean</em> <kbd>nz</kbd> variable where <kbd>nz[i][j] = 1</kbd> if and only if grid position \((i, j)\) is non-zero.</p>
<p>This variable feels redundant, as we should be able to just do things like <kbd>if grid[i][j] &gt; 0</kbd> right?  Technically yes, but encoding if-else statements directly in an ILP is cumbersome and confusing &ndash; the <kbd>nz</kbd> variable makes reasoning easier.  We&rsquo;ll see later how <kbd>z3</kbd> addresses this with higher level programming constructs.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># An indicator variable for whether position (i, j) is non-zero</span>
</span></span><span style="display:flex;"><span>nz <span style="color:#ff79c6">=</span> [[model<span style="color:#ff79c6">.</span>NewIntVar(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;nz_</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Encode the non-zero indicator</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(grid[i][j] <span style="color:#ff79c6">&lt;=</span> <span style="color:#8be9fd;font-style:italic">len</span>(N) <span style="color:#ff79c6">*</span> nz[i][j])
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(nz[i][j] <span style="color:#ff79c6">&lt;=</span> grid[i][j])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Each row and column must contain exactly four non-zero numbers</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> row <span style="color:#ff79c6">in</span> N:
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(<span style="color:#8be9fd;font-style:italic">sum</span>(nz[row]) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> col <span style="color:#ff79c6">in</span> N:
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(<span style="color:#8be9fd;font-style:italic">sum</span>(nz[i][col] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Every 2x2 subsquare must contain at least one empty cell</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]:
</span></span><span style="display:flex;"><span>        model<span style="color:#ff79c6">.</span>Add(nz[i][j] <span style="color:#ff79c6">+</span> nz[i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>][j] <span style="color:#ff79c6">+</span> nz[i][j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">+</span> nz[i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>][j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">3</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, the entries need to form a <em>connected region</em>.  This is the most difficult constraint to encode.  If you are confused about what constitutes a &ldquo;connected region&rdquo;, take a look at <a
    class="link"
    href="https://www.janestreet.com/puzzles/twenty-four-seven-solution/"target="_blank" rel="noopener">the solution</a
>
 &ndash; you can trace a path between any two filled in digits: there are no &ldquo;islands&rdquo;.</p>
<p>One idea is to try encode this is to do some kind of <a
    class="link"
    href="https://en.wikipedia.org/wiki/Connected-component_labeling"target="_blank" rel="noopener">connected component labeling</a
>
, but it seems difficult (to me?) to encode this in an ILP such that it is both necessary <em>and</em> sufficient.  That is, it is fairly easy to construct a set of ILP constraints which will be satisfied if there is just one connected component, but going in the other direction (that there is necessarily a single connected component when the constraints are satisfied) seems much more difficult.</p>
<p>An alternative method is to imagine that the cells and their neighbours form a network of pipes, and then model some kind of <em>flow</em> within that network.  We can let each non-zero part of the grid consume a single unit of flow, and then designate one of the given filled-in cells as a source with exactly enough units of flow to cover the whole grid.  Since there is one 1, two 2s, etc. up to seven 7s, we know there must be exactly 28 non-zero cells.</p>
<p>It is well known that flow problems can be modeled with linear programs, so this approach seems promising for our ILP.  The following code does exactly this &ndash; the comments should make the code fairly clear.  However, it can be subtle.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># The maximum amount of flow</span>
</span></span><span style="display:flex;"><span>NEEDED_FLOW <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">28</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_neighbours</span>(i, j):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#8be9fd;font-style:italic">len</span>(N):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">yield</span> (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, j)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">yield</span> (i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>, j)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#8be9fd;font-style:italic">len</span>(N):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">yield</span> (i, j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> j <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">yield</span> (i, j <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Outgoing flow from cell (i, j) to neighbouring cell (p, q)</span>
</span></span><span style="display:flex;"><span>flow <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    [
</span></span><span style="display:flex;"><span>        [
</span></span><span style="display:flex;"><span>            (p, q, model<span style="color:#ff79c6">.</span>NewIntVar(<span style="color:#bd93f9">0</span>, M, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;flow_</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}{</span>j<span style="color:#f1fa8c">}{</span>p<span style="color:#f1fa8c">}{</span>q<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> (p, q) <span style="color:#ff79c6">in</span> _neighbours(i, j)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Sum up all the outgoing flow</span>
</span></span><span style="display:flex;"><span>outgoing_flow <span style="color:#ff79c6">=</span> [[<span style="color:#bd93f9">0</span> <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> _, _, f <span style="color:#ff79c6">in</span> flow[i][j]:
</span></span><span style="display:flex;"><span>        outgoing_flow[i][j] <span style="color:#ff79c6">+=</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># And separately keep track of the incoming flow</span>
</span></span><span style="display:flex;"><span>incoming_flow <span style="color:#ff79c6">=</span> [[<span style="color:#bd93f9">0</span> <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> p, q, f <span style="color:#ff79c6">in</span> flow[i][j]:
</span></span><span style="display:flex;"><span>        incoming_flow[p][q] <span style="color:#ff79c6">+=</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Cells which are zero must have zero flow through them</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(outgoing_flow[i][j] <span style="color:#ff79c6">&lt;=</span> M <span style="color:#ff79c6">*</span> nz[i][j])
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(incoming_flow[i][j] <span style="color:#ff79c6">&lt;=</span> M <span style="color:#ff79c6">*</span> nz[i][j])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Pick an arbitrary fixed node as the source</span>
</span></span><span style="display:flex;"><span>i_source, j_source <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Give it enough flow to fill all non-zero cells (minus itself)</span>
</span></span><span style="display:flex;"><span>model<span style="color:#ff79c6">.</span>Add(
</span></span><span style="display:flex;"><span>    outgoing_flow[i_source][j_source] <span style="color:#ff79c6">==</span> NEEDED_FLOW <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># The source should have no incoming flow</span>
</span></span><span style="display:flex;"><span>incoming_flow[i_source][j_source] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Conserve flow in the network</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">==</span> i_source <span style="color:#ff79c6">and</span> j <span style="color:#ff79c6">==</span> j_source:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Except the source is unconstrained</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># non-zero cells must have positive incoming flow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># which ensures they&#39;re connected to the source</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(incoming_flow[i][j] <span style="color:#ff79c6">&gt;=</span> nz[i][j])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># The outgoing flow must be one less than the incoming flow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># i.e., each node sinks 1 unit of flow.</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">.</span>Add(outgoing_flow[i][j] <span style="color:#ff79c6">==</span> incoming_flow[i][j] <span style="color:#ff79c6">-</span> nz[i][j])
</span></span></code></pre></td></tr></table>
</div>
</div><p>This code looks fairly simple, but writing it was quite a challenge.  It was particularly difficult to write down the right constraints that ensured only the one designated node could act as a source.  In many earlier iterations I failed to properly enforce this and wound up with islands of non-zero cells.  I also had a subtle bug wherein I wrote <kbd>model.Add(outgoing_flow[i][j] == incoming_flow[i][j] - 1)</kbd> instead of <kbd>model.Add(outgoing_flow[i][j] == incoming_flow[i][j] - nz[i][j])</kbd>.</p>
<p><kbd><strong>Remark</strong>:   When I originally solved the 24-7 puzzle (and the 4-in-1 puzzle below) I actually didn&rsquo;t encode the path constraint condition.  Instead, I just encoded a simpler sufficient condition and printed out all of the possible solutions (there were only 3) and selected the correct one manually &ndash; an expedient method.</kbd></p>
<p>In any case, we can finally print out a solution.  I&rsquo;ve hidden the implementation of the <kbd>panel_to_str</kbd> function as it is uninteresting.  It just relies on getting the value of variables in the program with the method <kbd>solver.Value</kbd>, for example: <kbd>solver.Value(panel[k][i][j])</kbd>, <em>etc</em>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> solver<span style="color:#ff79c6">.</span>Solve(model) <span style="color:#ff79c6">==</span> cp_model<span style="color:#ff79c6">.</span>OPTIMAL:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Optimal solution found:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(panel_to_str(panel, solver))
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;FAILED TO FIND A SOLUTION&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Optimal solution found:
</span></span><span style="display:flex;"><span>7, 4, 3, 0, 6, 0, 0
</span></span><span style="display:flex;"><span>0, 0, 6, 3, 5, 0, 6
</span></span><span style="display:flex;"><span>0, 0, 5, 0, 5, 5, 5
</span></span><span style="display:flex;"><span>0, 3, 6, 4, 0, 0, 7
</span></span><span style="display:flex;"><span>4, 7, 0, 0, 0, 7, 2
</span></span><span style="display:flex;"><span>2, 0, 0, 7, 4, 7, 0
</span></span><span style="display:flex;"><span>7, 6, 0, 6, 0, 1, 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>And there we have it 😀</p>


<h2 class="group " id="solving-the-4-in-1-puzzle"
    >Solving the 4-in-1 Puzzle<a href="#solving-the-4-in-1-puzzle"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h2>

<p>The previous example with the 24-7 puzzle shows that ILP can be a rather cumbersome approach to encoding constraint programming problems, particularly if you endeavor to <em>directly</em> construct all of the linear inequalities needed to encode your program.  In this section, I&rsquo;m going to use the <a
    class="link"
    href="https://en.wikipedia.org/wiki/Z3_Theorem_Prover"target="_blank" rel="noopener">z3 theorem prover</a
>
 for SMT, which I think is considerably more expressive.</p>
<p>I&rsquo;ll also be tackling a more difficult puzzle &ndash; the 4-in-1 24-7 puzzle.  Indeed, the previous section was merely a warm up.  The specific rules for the 4-in-1 puzzle is to:</p>
<p><kbd>Place numbers in some of the empty cells so that in total each of the four 7-by-7 outlined grids is a legal “Twenty Four Seven” grid. Namely: each 7-by-7 grid’s interior should contain one 1, two 2’s, etc., up to seven 7’s. Furthermore, each row and column within the 7-by-7’s must contain exactly 4 numbers which sum to 20. Finally, the numbered cells must form a connected region, but every 2-by-2 subsquare in the completed grid must contain at least one empty cell.</kbd></p>
<p><kbd>Some numbers have been placed inside the grid. Additionally, some blue numbers have been placed outside of the grids. A number outside the grid represents either the sum of the row or column it is facing, or the value of the first number it sees in that row or column.</kbd></p>
<figure><img src="2474_puzzle.png"
         alt="Figure 3: The 4-in-1 24-7 Puzzle"/><figcaption>
            <p><span class="figure-number">Figure 3: </span>The 4-in-1 24-7 Puzzle</p>
        </figcaption>
</figure>

<p>Let&rsquo;s begin!</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> z3
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> itertools <span style="color:#ff79c6">import</span> product
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MAX_VAL <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">7</span>
</span></span><span style="display:flex;"><span>OFFSET <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>N <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>)  <span style="color:#6272a4"># Subgrid size</span>
</span></span><span style="display:flex;"><span>K <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">8</span>)  <span style="color:#6272a4"># Available values</span>
</span></span><span style="display:flex;"><span>full_N <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">12</span>)  <span style="color:#6272a4"># The whole grid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># The full grid</span>
</span></span><span style="display:flex;"><span>grid <span style="color:#ff79c6">=</span> [[z3<span style="color:#ff79c6">.</span>Int(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;x_</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">_</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> full_N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> full_N]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># And each of the subgrids</span>
</span></span><span style="display:flex;"><span>grids <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    [[[grid[i <span style="color:#ff79c6">+</span> di][j <span style="color:#ff79c6">+</span> dj] <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> dj <span style="color:#ff79c6">in</span> (<span style="color:#bd93f9">0</span>, OFFSET)]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> di <span style="color:#ff79c6">in</span> (<span style="color:#bd93f9">0</span>, OFFSET)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># We&#39;ll append all our constraints here</span>
</span></span><span style="display:flex;"><span>constraints <span style="color:#ff79c6">=</span> []
</span></span></code></pre></td></tr></table>
</div>
</div><p>As before, I&rsquo;m keeping track of the grid values, with a separate convenience array for the subgrids.  As opposed to ILP, <kbd>z3</kbd> is expressive enough that I don&rsquo;t have to directly introduce multiple separate variables for different conditions like <kbd>nz</kbd>, <kbd>panel</kbd>, <em>etc.</em></p>
<p>Constraints are set similarly, and can also be <em>tagged</em>.  The constraints list will contain tuples of the form <kbd>(tag, constraint)</kbd>, as the tag can be useful for debugging.  You can ask <kbd>z3</kbd> to print out the tags of some set of unsatisfiable constraints (whenever it finds one), so you can track down bugs more easily.  Ironically, I didn&rsquo;t actually make proper use of this feature, since I noticed the bug I was searching for during the process of meticulously tagging each constraint.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Manually encode the grid</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>extend(
</span></span><span style="display:flex;"><span>    [
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[1][3] = 1&#34;</span>, grid[<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[1][9] = 6&#34;</span>, grid[<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">9</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">6</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[1][10] = 5&#34;</span>, grid[<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">10</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">5</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[2][5] = 3&#34;</span>, grid[<span style="color:#bd93f9">2</span>][<span style="color:#bd93f9">5</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">3</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[2][10] = 6&#34;</span>, grid[<span style="color:#bd93f9">2</span>][<span style="color:#bd93f9">10</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">6</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[3][1] = 4&#34;</span>, grid[<span style="color:#bd93f9">3</span>][<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[3][8] = 7&#34;</span>, grid[<span style="color:#bd93f9">3</span>][<span style="color:#bd93f9">8</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">7</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[4][4] = 2&#34;</span>, grid[<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[4][11] = 7&#34;</span>, grid[<span style="color:#bd93f9">4</span>][<span style="color:#bd93f9">11</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">7</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[5][2] = 6&#34;</span>, grid[<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">6</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[5][8] = 3&#34;</span>, grid[<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">8</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">3</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[5][9] = 7&#34;</span>, grid[<span style="color:#bd93f9">5</span>][<span style="color:#bd93f9">9</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">7</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[8][3] = 7&#34;</span>, grid[<span style="color:#bd93f9">8</span>][<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">7</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[8][5] = 5&#34;</span>, grid[<span style="color:#bd93f9">8</span>][<span style="color:#bd93f9">5</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">5</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[9][1] = 5&#34;</span>, grid[<span style="color:#bd93f9">9</span>][<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">5</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[9][5] = 7&#34;</span>, grid[<span style="color:#bd93f9">9</span>][<span style="color:#bd93f9">5</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">7</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[10][1] = 6&#34;</span>, grid[<span style="color:#bd93f9">10</span>][<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">6</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[10][2] = 7&#34;</span>, grid[<span style="color:#bd93f9">10</span>][<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">7</span>),
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">&#34;g[11][4] = 6&#34;</span>, grid[<span style="color:#bd93f9">11</span>][<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">6</span>),
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>I didn&rsquo;t set bounds for the variables when I constructed them, so lets do that here.  Notice that <kbd>z3</kbd> directly supports convenient constructs like <kbd>z3.And</kbd>.  There is also <kbd>z3.Or, z3.Implies, z3.If</kbd>, and many others &ndash; pay attention for these throughout.  These functions make it much easier to encode the constraints than having to reason through encoding them with ILP.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Bounds for all the integers</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>extend(
</span></span><span style="display:flex;"><span>    [
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;bounds_[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>, z3<span style="color:#ff79c6">.</span>And(grid[i][j] <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>, grid[i][j] <span style="color:#ff79c6">&lt;=</span> MAX_VAL))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(full_N, full_N)
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following lengthy code block implements again the 24-7 puzzle logic, but this time in <kbd>z3</kbd>.  Since I&rsquo;ve already explained it, I don&rsquo;t do so again, except for the comments in the code itself.  Consider comparing this code with the ILP implementation.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">encode_247_puzzle</span>(subgrid_ix, flow_source: <span style="color:#8be9fd;font-style:italic">tuple</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    The flow_source is an integer tuple for where flow originates from.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    i_sg, j_sg <span style="color:#ff79c6">=</span> subgrid_ix
</span></span><span style="display:flex;"><span>    subgrid <span style="color:#ff79c6">=</span> grids[i_sg][j_sg]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_neighbours</span>(i, j):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#8be9fd;font-style:italic">len</span>(N):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">yield</span> (i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, j)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">yield</span> (i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>, j)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#8be9fd;font-style:italic">len</span>(N):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">yield</span> (i, j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> j <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">yield</span> (i, j <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    constraints <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># For every row and column</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> row <span style="color:#ff79c6">in</span> N:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># They must contain exactly four non-zero numbers</span>
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;row_count4_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>row<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">sum</span>(z3<span style="color:#ff79c6">.</span>If(subgrid[row][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># And sum up to exactly 20</span>
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append((<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;row_sum20_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>row<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>, <span style="color:#8be9fd;font-style:italic">sum</span>(subgrid[row]) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">20</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> col <span style="color:#ff79c6">in</span> N:
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;col_count4_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>col<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">sum</span>(z3<span style="color:#ff79c6">.</span>If(subgrid[i][col] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;col_sum20_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>col<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>, <span style="color:#8be9fd;font-style:italic">sum</span>(subgrid[i][col] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">20</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Must contain one 1, two 2s, ..., seven 7s.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> k <span style="color:#ff79c6">in</span> K:
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;counts_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>k<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">sum</span>(z3<span style="color:#ff79c6">.</span>If(subgrid[i][j] <span style="color:#ff79c6">==</span> k, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N)) <span style="color:#ff79c6">==</span> k,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Every 2x2 subsquare must contain at least one zero</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]:
</span></span><span style="display:flex;"><span>            constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>                (
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;2x2_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                    (
</span></span><span style="display:flex;"><span>                        z3<span style="color:#ff79c6">.</span>If(subgrid[i][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">+</span> z3<span style="color:#ff79c6">.</span>If(subgrid[i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">+</span> z3<span style="color:#ff79c6">.</span>If(subgrid[i][j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">+</span> z3<span style="color:#ff79c6">.</span>If(subgrid[i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>][j <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">3</span>,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Again implementing path connectedness by using the flow model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Outgoing flow from cell (i, j) to neighbouring cell (p, q)</span>
</span></span><span style="display:flex;"><span>    flow <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>        [
</span></span><span style="display:flex;"><span>            [
</span></span><span style="display:flex;"><span>                (p, q, z3<span style="color:#ff79c6">.</span>Int(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;flow_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>p<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>q<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> (p, q) <span style="color:#ff79c6">in</span> _neighbours(i, j)
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> p, q, f <span style="color:#ff79c6">in</span> flow[i][j]:
</span></span><span style="display:flex;"><span>            constraints<span style="color:#ff79c6">.</span>append((<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;f_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>p<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>q<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">] &gt;= 0&#34;</span>, f <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>))
</span></span><span style="display:flex;"><span>            constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>                (<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;f_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>p<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>q<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">] &lt;= M&#34;</span>, f <span style="color:#ff79c6">&lt;=</span> <span style="color:#8be9fd;font-style:italic">len</span>(N) <span style="color:#ff79c6">**</span> <span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Sum up all the outgoing flow</span>
</span></span><span style="display:flex;"><span>    outgoing_flow <span style="color:#ff79c6">=</span> [[<span style="color:#bd93f9">0</span> <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> _, _, f <span style="color:#ff79c6">in</span> flow[i][j]:
</span></span><span style="display:flex;"><span>            outgoing_flow[i][j] <span style="color:#ff79c6">+=</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># And separately keep track of the incoming flow</span>
</span></span><span style="display:flex;"><span>    incoming_flow <span style="color:#ff79c6">=</span> [[<span style="color:#bd93f9">0</span> <span style="color:#ff79c6">for</span> j <span style="color:#ff79c6">in</span> N] <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> N]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> p, q, f <span style="color:#ff79c6">in</span> flow[i][j]:
</span></span><span style="display:flex;"><span>            incoming_flow[p][q] <span style="color:#ff79c6">+=</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Cells which are zero must have zero flow through them</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;flowbal_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                z3<span style="color:#ff79c6">.</span>Implies(
</span></span><span style="display:flex;"><span>                    subgrid[i][j] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>                    z3<span style="color:#ff79c6">.</span>And(outgoing_flow[i][j] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>, incoming_flow[i][j] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>),
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># The source has exactly enough outgoing flow to fill the network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># This time, I directly summed up the count of non-zero entries.</span>
</span></span><span style="display:flex;"><span>    i_source, j_source <span style="color:#ff79c6">=</span> flow_source
</span></span><span style="display:flex;"><span>    constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>        (<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;sourceinc_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>, incoming_flow[i_source][j_source] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>        (
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;sourceout_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>,
</span></span><span style="display:flex;"><span>            outgoing_flow[i_source][j_source]
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">sum</span>(z3<span style="color:#ff79c6">.</span>If(subgrid[i][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Conserve flow in the network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(N, N):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">==</span> i_source <span style="color:#ff79c6">and</span> j <span style="color:#ff79c6">==</span> j_source:
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Except the source is unconstrained</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># non-zero cells must have positive incoming flow</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># which ensures they&#39;re connected to the source</span>
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;nzflow+_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                z3<span style="color:#ff79c6">.</span>Implies(subgrid[i][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, incoming_flow[i][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># The outgoing flow must be one less than the incoming flow,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># i.e., each node sinks 1 unit of flow.</span>
</span></span><span style="display:flex;"><span>        constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;sink+_</span><span style="color:#f1fa8c">{</span>i_sg<span style="color:#f1fa8c">}{</span>j_sg<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>                outgoing_flow[i][j]
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">==</span> incoming_flow[i][j] <span style="color:#ff79c6">-</span> z3<span style="color:#ff79c6">.</span>If(subgrid[i][j] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> constraints
</span></span></code></pre></td></tr></table>
</div>
</div><p>This function is now being used as a subroutine &ndash; each subgrid needs to be a valid 24-7 puzzle.  I specify the flow sources for each subgrid manually and arbitrarily from the fixed given data.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Pick some arbitrary fixed nodes for the zero groups.</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>extend(encode_247_puzzle((<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>), (<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">3</span>)))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>extend(encode_247_puzzle((<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>), (<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">2</span>)))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>extend(encode_247_puzzle((<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>), (<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0</span>)))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>extend(encode_247_puzzle((<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>), (<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">3</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, there are some additional rules described for the 4-in-1 puzzle.  Specifically, recall:</p>
<p><kbd>Some numbers have been placed inside the grid. Additionally, some blue numbers have been placed outside the grid. A number outside the grid represents either the sum of the row or column it is facing, or the value of the first number it sees in that row or column.</kbd></p>
<p>This constraint is a bit confusing, but ultimately we can just encode it with a sequence of nested if/else statements.  I&rsquo;ve constructed this with a recursive function as follows, but one could just as easily write down the constraints &ldquo;manually&rdquo; with a <a
    class="link"
    href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Keyboard-Macros.html"target="_blank" rel="noopener">keyboard macro</a
>
.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">blue_num_constraint</span>(i: <span style="color:#8be9fd;font-style:italic">int</span>, j: <span style="color:#8be9fd;font-style:italic">int</span>, di: <span style="color:#8be9fd;font-style:italic">int</span>, dj: <span style="color:#8be9fd;font-style:italic">int</span>, num):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Starting at position i, j and moving in the direction di, dj,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    either the sum of the whole line is num OR the first non-zero
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    value encountered is equal to num.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">nest_if_else</span>(m):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> m <span style="color:#ff79c6">&gt;=</span> <span style="color:#8be9fd;font-style:italic">len</span>(full_N):
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Terminal condition: we reached the end of the row or column</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            g <span style="color:#ff79c6">=</span> grid[i <span style="color:#ff79c6">+</span> m <span style="color:#ff79c6">*</span> di][j <span style="color:#ff79c6">+</span> m <span style="color:#ff79c6">*</span> dj]
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># If g &gt; 0 then it must equal num.  Otherwise, check the next cell.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> z3<span style="color:#ff79c6">.</span>If(g <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>, g <span style="color:#ff79c6">==</span> num, nest_if_else(m <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;blue_[</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>j<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>di<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>dj<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">][</span><span style="color:#f1fa8c">{</span>num<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Either the sum of the row or column is num, or we go into the nested if else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># statements to constraint the value of the first non-zero entry.</span>
</span></span><span style="display:flex;"><span>        z3<span style="color:#ff79c6">.</span>Or(
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">sum</span>(grid[i <span style="color:#ff79c6">+</span> m <span style="color:#ff79c6">*</span> di][j <span style="color:#ff79c6">+</span> m <span style="color:#ff79c6">*</span> dj] <span style="color:#ff79c6">for</span> m <span style="color:#ff79c6">in</span> full_N) <span style="color:#ff79c6">==</span> num, nest_if_else(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></td></tr></table>
</div>
</div><p>We now need to manually write down all the constraints from the figure.  I enumerate them in counter-clockwise order, starting from the top-left corner.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Down the left side</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">5</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">7</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">7</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">33</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">29</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">6</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">40</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">7</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">28</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">36</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># left-to-right along the bottom</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">6</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">3</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">4</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">11</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Up the right side</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">7</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">4</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># right-to-left along the top</span>
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">7</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">7</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">27</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">6</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">40</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">3</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">27</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">34</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">30</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">36</span>))
</span></span><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(blue_num_constraint(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">6</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, we instantiate and call the solver.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">solve_constraints</span>(constrs):
</span></span><span style="display:flex;"><span>    solver <span style="color:#ff79c6">=</span> z3<span style="color:#ff79c6">.</span>Solver()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Add all the tagged constraints</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> tag, constr <span style="color:#ff79c6">in</span> constrs:
</span></span><span style="display:flex;"><span>        solver<span style="color:#ff79c6">.</span>assert_and_track(constr, tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># This will enable the solver to tell you about a subset of unsat constraints.</span>
</span></span><span style="display:flex;"><span>    solver<span style="color:#ff79c6">.</span>set(unsat_core<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> solver<span style="color:#ff79c6">.</span>check() <span style="color:#ff79c6">==</span> z3<span style="color:#ff79c6">.</span>sat:
</span></span><span style="display:flex;"><span>        solution <span style="color:#ff79c6">=</span> solver<span style="color:#ff79c6">.</span>model()
</span></span><span style="display:flex;"><span>        print_full_grid(solution, grid)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> solution
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;INFEASIBLE&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># The unsat core is some subset of unsat constraints.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># It need not be minimal in any sense, but may be useful for</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># debugging.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Unsat subset: &#34;</span>, solver<span style="color:#ff79c6">.</span>unsat_core())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>solution <span style="color:#ff79c6">=</span> solve_constraints(constraints)
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0, 5, 0, 6, 0 | 3, 6 | 0, 0, 0, 7, 4
</span></span><span style="display:flex;"><span>0, 7, 7, 1, 0 | 0, 5 | 0, 4, 6, 5, 0
</span></span><span style="display:flex;"><span>0, 0, 0, 7, 5 | 3, 5 | 0, 6, 0, 6, 0
</span></span><span style="display:flex;"><span>6, 4, 3, 0, 0 | 7, 0 | 5, 7, 1, 0, 0
</span></span><span style="display:flex;"><span>7, 0, 0, 0, 2 | 7, 4 | 2, 0, 0, 0, 7
</span></span><span style="display:flex;"><span>------------------------------------
</span></span><span style="display:flex;"><span>2, 0, 6, 6, 6 | 0, 0 | 6, 3, 7, 0, 4
</span></span><span style="display:flex;"><span>5, 4, 4, 0, 7 | 0, 0 | 7, 0, 6, 2, 5
</span></span><span style="display:flex;"><span>------------------------------------
</span></span><span style="display:flex;"><span>7, 0, 0, 0, 1 | 5, 7 | 1, 0, 0, 7, 0
</span></span><span style="display:flex;"><span>0, 5, 3, 7, 0 | 5, 0 | 0, 5, 0, 4, 6
</span></span><span style="display:flex;"><span>6, 5, 0, 0, 0 | 7, 2 | 0, 6, 0, 0, 5
</span></span><span style="display:flex;"><span>0, 6, 7, 3, 0 | 0, 4 | 6, 6, 4, 0, 0
</span></span><span style="display:flex;"><span>0, 0, 0, 4, 6 | 3, 7 | 0, 0, 3, 7, 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Which is a correct solution!  We can also check that the solution is unique by adding the negation of the solution back as another constraint and then re-solving.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>constraints<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>    (
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;soln1&#34;</span>,
</span></span><span style="display:flex;"><span>        z3<span style="color:#ff79c6">.</span>Or([grid[i][j] <span style="color:#ff79c6">!=</span> solution[grid[i][j]] <span style="color:#ff79c6">for</span> i, j <span style="color:#ff79c6">in</span> product(full_N, full_N)]),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>solve_constraints(constraints)
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>INFEASIBLE
</span></span><span style="display:flex;"><span>Unsat subset:  [g[1][3] = 1,
</span></span><span style="display:flex;"><span> g[1][9] = 6,
</span></span><span style="display:flex;"><span> g[1][10] = 5,
</span></span><span style="display:flex;"><span> g[2][5] = 3,
</span></span><span style="display:flex;"><span> g[2][10] = 6,
</span></span><span style="display:flex;"><span> g[3][1] = 4,
</span></span><span style="display:flex;"><span> g[3][8] = 7,
</span></span><span style="display:flex;"><span> g[4][4] = 2,
</span></span><span style="display:flex;"><span> g[4][11] = 7,
</span></span><span style="display:flex;"><span> g[5][2] = 6,
</span></span><span style="display:flex;"><span> g[5][8] = 3,
</span></span><span style="display:flex;"><span> g[5][9] = 7,
</span></span><span style="display:flex;"><span> g[8][3] = 7,
</span></span><span style="display:flex;"><span> g[8][5] = 5,
</span></span><span style="display:flex;"><span> g[9][1] = 5,
</span></span><span style="display:flex;"><span> g[9][5] = 7,
</span></span><span style="display:flex;"><span> g[10][1] = 6,
</span></span><span style="display:flex;"><span> g[10][2] = 7,
</span></span><span style="display:flex;"><span> g[11][4] = 6,
</span></span><span style="display:flex;"><span> bounds_[0][0],
</span></span><span style="display:flex;"><span> bounds_[0][1],
</span></span><span style="display:flex;"><span> bounds_[0][2],
</span></span><span style="display:flex;"><span> bounds_[0][3],
</span></span><span style="display:flex;"><span> bounds_[0][4],
</span></span><span style="display:flex;"><span> bounds_[0][6],
</span></span><span style="display:flex;"><span> bounds_[0][7],
</span></span><span style="display:flex;"><span> bounds_[0][8],
</span></span><span style="display:flex;"><span> bounds_[0][9],
</span></span><span style="display:flex;"><span> bounds_[0][10],
</span></span><span style="display:flex;"><span> bounds_[1][0],
</span></span><span style="display:flex;"><span> bounds_[1][1],
</span></span><span style="display:flex;"><span> bounds_[1][2],
</span></span><span style="display:flex;"><span> bounds_[1][3],
</span></span><span style="display:flex;"><span> bounds_[1][4],
</span></span><span style="display:flex;"><span> bounds_[1][5],
</span></span><span style="display:flex;"><span> bounds_[1][6],
</span></span><span style="display:flex;"><span> bounds_[1][7],
</span></span><span style="display:flex;"><span> bounds_[1][8],
</span></span><span style="display:flex;"><span> bounds_[1][11],
</span></span><span style="display:flex;"><span> bounds_[2][0],
</span></span><span style="display:flex;"><span> bounds_[2][1],
</span></span><span style="display:flex;"><span> bounds_[2][2],
</span></span><span style="display:flex;"><span> bounds_[2][3],
</span></span><span style="display:flex;"><span> bounds_[2][4],
</span></span><span style="display:flex;"><span> bounds_[2][6],
</span></span><span style="display:flex;"><span> bounds_[2][7],
</span></span><span style="display:flex;"><span> bounds_[2][8],
</span></span><span style="display:flex;"><span> bounds_[2][9],
</span></span><span style="display:flex;"><span> bounds_[2][11],
</span></span><span style="display:flex;"><span> bounds_[3][0],
</span></span><span style="display:flex;"><span> bounds_[3][1],
</span></span><span style="display:flex;"><span> bounds_[3][2],
</span></span><span style="display:flex;"><span> bounds_[3][3],
</span></span><span style="display:flex;"><span> bounds_[3][4],
</span></span><span style="display:flex;"><span> bounds_[3][5],
</span></span><span style="display:flex;"><span> bounds_[3][6],
</span></span><span style="display:flex;"><span> bounds_[3][7],
</span></span><span style="display:flex;"><span> bounds_[3][8],
</span></span><span style="display:flex;"><span> bounds_[3][9],
</span></span><span style="display:flex;"><span> bounds_[3][10],
</span></span><span style="display:flex;"><span> bounds_[3][11],
</span></span><span style="display:flex;"><span> bounds_[4][0],
</span></span><span style="display:flex;"><span> bounds_[4][1],
</span></span><span style="display:flex;"><span> bounds_[4][2],
</span></span><span style="display:flex;"><span> bounds_[4][3],
</span></span><span style="display:flex;"><span> bounds_[4][5],
</span></span><span style="display:flex;"><span> bounds_[4][6],
</span></span><span style="display:flex;"><span> bounds_[4][7],
</span></span><span style="display:flex;"><span> bounds_[4][8],
</span></span><span style="display:flex;"><span> bounds_[4][9],
</span></span><span style="display:flex;"><span> bounds_[4][10],
</span></span><span style="display:flex;"><span> bounds_[4][11],
</span></span><span style="display:flex;"><span> bounds_[5][1],
</span></span><span style="display:flex;"><span> bounds_[5][4],
</span></span><span style="display:flex;"><span> bounds_[5][5],
</span></span><span style="display:flex;"><span> bounds_[5][6],
</span></span><span style="display:flex;"><span> bounds_[5][7],
</span></span><span style="display:flex;"><span> bounds_[5][9],
</span></span><span style="display:flex;"><span> bounds_[5][10],
</span></span><span style="display:flex;"><span> bounds_[5][11],
</span></span><span style="display:flex;"><span> bounds_[6][0],
</span></span><span style="display:flex;"><span> bounds_[6][1],
</span></span><span style="display:flex;"><span> bounds_[6][3],
</span></span><span style="display:flex;"><span> bounds_[6][4],
</span></span><span style="display:flex;"><span> bounds_[6][5],
</span></span><span style="display:flex;"><span> bounds_[6][6],
</span></span><span style="display:flex;"><span> bounds_[6][7],
</span></span><span style="display:flex;"><span> bounds_[6][8],
</span></span><span style="display:flex;"><span> bounds_[6][9],
</span></span><span style="display:flex;"><span> bounds_[6][10],
</span></span><span style="display:flex;"><span> bounds_[6][11],
</span></span><span style="display:flex;"><span> bounds_[7][0],
</span></span><span style="display:flex;"><span> bounds_[7][1],
</span></span><span style="display:flex;"><span> bounds_[7][2],
</span></span><span style="display:flex;"><span> bounds_[7][3],
</span></span><span style="display:flex;"><span> bounds_[7][4],
</span></span><span style="display:flex;"><span> bounds_[7][5],
</span></span><span style="display:flex;"><span> bounds_[7][6],
</span></span><span style="display:flex;"><span> bounds_[7][7],
</span></span><span style="display:flex;"><span> bounds_[7][8],
</span></span><span style="display:flex;"><span> bounds_[7][9],
</span></span><span style="display:flex;"><span> bounds_[7][10],
</span></span><span style="display:flex;"><span> bounds_[7][11],
</span></span><span style="display:flex;"><span> bounds_[8][0],
</span></span><span style="display:flex;"><span> bounds_[8][1],
</span></span><span style="display:flex;"><span> bounds_[8][2],
</span></span><span style="display:flex;"><span> bounds_[8][3],
</span></span><span style="display:flex;"><span> bounds_[8][4],
</span></span><span style="display:flex;"><span> bounds_[8][6],
</span></span><span style="display:flex;"><span> bounds_[8][7],
</span></span><span style="display:flex;"><span> bounds_[8][8],
</span></span><span style="display:flex;"><span> bounds_[8][9],
</span></span><span style="display:flex;"><span> bounds_[8][10],
</span></span><span style="display:flex;"><span> bounds_[8][11],
</span></span><span style="display:flex;"><span> bounds_[9][0],
</span></span><span style="display:flex;"><span> bounds_[9][2],
</span></span><span style="display:flex;"><span> bounds_[9][3],
</span></span><span style="display:flex;"><span> bounds_[9][4],
</span></span><span style="display:flex;"><span> bounds_[9][5],
</span></span><span style="display:flex;"><span> bounds_[9][6],
</span></span><span style="display:flex;"><span> bounds_[9][7],
</span></span><span style="display:flex;"><span> bounds_[9][8],
</span></span><span style="display:flex;"><span> bounds_[9][9],
</span></span><span style="display:flex;"><span> bounds_[9][10],
</span></span><span style="display:flex;"><span> bounds_[9][11],
</span></span><span style="display:flex;"><span> bounds_[10][0],
</span></span><span style="display:flex;"><span> bounds_[10][1],
</span></span><span style="display:flex;"><span> bounds_[10][2],
</span></span><span style="display:flex;"><span> bounds_[10][3],
</span></span><span style="display:flex;"><span> ...]
</span></span></code></pre></td></tr></table>
</div>
</div><p>This proves that the solution I found is unique, and also serves to illustrate the &ldquo;unsat subset&rdquo; functionality.</p>
<p><kbd><strong>Remark</strong>: You can find my name on the</kbd> <a
    class="link"
    href="https://www.janestreet.com/puzzles/twenty-four-seven-four-in-one-solution/"target="_blank" rel="noopener">solution page</a
>
 <kbd>of this puzzle, so you know I&rsquo;m no fraud.  But similarly as the vanilla 24-7 puzzle, I didn&rsquo;t fully encode the entire problem as I&rsquo;ve done now.  Instead, since I only cared about getting to a final result, I manually narrowed down some of the constraints with my own direct reasoning, or through sufficient conditions, and then printed out all the candidate solutions (there were 8) with ILP.  I finally found the only correct one ad-hoc, and computed the product of the areas of white space by hand.</kbd></p>


<h2 class="group " id="conclusion"
    >Conclusion<a href="#conclusion"
        ><i class="eva eva-link ml-3 align-middle text-theme opacity-0 transition ease-in-out group-hover:opacity-100"></i></a
></h2>

<p>We&rsquo;ve seen how both Integer Linear Programming (ILP) and Satisfiability Modulo Theories (SMT), a generalization of SAT, can be used to solve constraint programming problems.  These tools are incredibly powerful, and it seems likely that most practical &ldquo;day to day&rdquo; discrete optimization problems I might care to solve can be easily implemented and solved with <kbd>ortools</kbd> or <kbd>z3</kbd>.  I find <kbd>z3</kbd> to be considerably more expressive than ILP, and it is probably a good go-to tool for constraint programming.  That being said, there are plenty of mathematical optimization problems which can be encoded as ILPs, so if optimization is the goal, rather than simple constraint satisfaction, ILP might be the right choice.</p></section>
<div class="flex items-center justify-center px-6 pb-5 pt-4 text-center text-xl text-gray-500 md:px-10 md:pb-10 md:pt-14"><a
                class="mr-4 inline-flex h-5 w-5 items-center"
                title="Share to twitter"
                href="https://twitter.com/share?&text=Solving%20puzzles%20with%20computers.&url=https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/"
                target="_blank"
                rel="noopener noreferrer"
                ><i class="eva eva-twitter hover:text-theme"></i
            ></a><a
                class="mr-4 inline-flex h-5 w-5 items-center"
                title="Share to weibo"
                href="https://service.weibo.com/share/share.php?url=https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/&title=Constraint%20Programming,%20Puzzles,%20ILP,%20and%20z3&sudaref=rjtk.github.io"
                target="_blank"
                rel="noopener noreferrer"
            ><svg class="inline-block h-5 w-5 fill-current hover:text-theme" viewBox="0 0 1193 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2681" width="200" height="200"> <path d="M456.991736 557.336482c-107.598583 0-194.644628 74.956316-194.644629 166.838252s87.046045 166.838253 194.644629 166.838253c107.598583 0 194.644628-74.956316 194.644628-166.838253s-87.046045-166.838253-194.644628-166.838252zM391.707202 822.101535c-36.269185 0-66.493506-27.806375-66.493507-62.866588s29.015348-62.866588 66.493507-62.866588c36.269185 0 66.493506 27.806375 66.493506 62.866588S427.976387 822.101535 391.707202 822.101535z m93.090909-91.881936c-14.507674 0-26.597403-12.089728-26.597403-26.597403s12.089728-26.597403 26.597403-26.597403 26.597403 12.089728 26.597403 26.597403-12.089728 26.597403-26.597403 26.597403zM239.376623 281.690673C97.9268 394.125148-18.134593 600.859504 30.224321 661.308146c32.642267 41.105077 59.239669-19.343566 124.524203-89.46399 30.224321-32.642267 77.374262-54.403778 122.106258-90.672964 20.552538-16.92562 197.062574-35.060213 230.913813-35.060212 97.9268-99.135773 114.85242-207.943329 74.956316-258.720189-48.358914-59.239669-201.898465-16.92562-343.348288 94.299882z" p-id="2682" ></path> <path d="M808.802834 560.9634C906.729634 461.827627 911.565525 377.199528 870.460449 326.422668c-47.149941-60.448642-211.570248-32.642267-351.811098 78.583235" p-id="2683" ></path> <path d="M605.695396 353.020071c-14.507674 8.46281-25.38843 12.089728-29.015349 7.253837-1.208973-2.417946-1.208973-6.044864 1.208973-9.671783-16.92562-1.208973-33.85124-1.208973-50.776859-1.208973C235.749705 349.393152 0 500.514758 0 686.696576s235.749705 337.303424 527.112161 337.303424 527.112161-151.121606 527.11216-337.303424c0-170.465171-194.644628-309.497048-448.528925-333.676505zM481.171192 959.924439C275.645809 959.924439 108.807556 847.489965 108.807556 708.458087s166.838253-251.466352 372.363636-251.466351 372.363636 112.434475 372.363637 251.466351-166.838253 251.466352-372.363637 251.466352z" p-id="2684" ></path> <path d="M1021.582054 423.140496c-3.626919 0-6.044864 0-9.671782-1.208973-18.134593-4.835891-29.015348-24.179457-22.970485-42.31405 2.417946-7.253837 3.626919-16.92562 3.626919-29.015348 0-65.284534-53.194805-119.688312-119.688312-119.688312-19.343566 0-33.85124-15.716647-33.851239-33.851239s15.716647-33.85124 33.851239-33.85124c103.971665 0 187.390791 84.628099 187.390791 187.390791 0 18.134593-2.417946 33.85124-6.044864 48.358914-4.835891 14.507674-18.134593 24.179457-32.642267 24.179457z" p-id="2685" ></path> <path d="M1146.106257 473.917355c-2.417946 0-6.044864 0-8.46281-1.208972-20.552538-4.835891-32.642267-25.38843-27.806375-45.940969 6.044864-24.179457 8.46281-47.149941 8.46281-71.329397C1118.299882 201.898465 991.357733 74.956316 836.609209 74.956316c-20.552538 0-37.478158-16.92562-37.478158-37.478158S816.056671 0 836.609209 0c197.062574 0 356.646989 159.584416 356.646989 356.646989 0 29.015348-3.626919 59.239669-10.880755 88.255018-3.626919 18.134593-19.343566 29.015348-36.269186 29.015348z" p-id="2686" ></path> </svg></a><i class="eva eva-copy mr-4 cursor-pointer hover:text-theme" title="Copy Link" data-clipboard-text="https://rjtk.github.io/posts/constraint-programming-puzzles-ilp-and-z3/"></i></div>
<div class="border-b dark:border-darkBorder"></div><div class="flex justify-between px-2 py-4 text-xl md:px-6 md:text-2xl">
    <div>
        <a
            href="/posts/all-about-quadratic-forms/"
            title="All About Quadratic Forms"
            class="invisible flex cursor-pointer items-center text-gray-500 transition duration-300 ease-[ease] hover:text-theme dark:text-darkTextPlaceholder dark:hover:text-darkText"style="visibility: visible;">
            <span class="flex items-center text-5xl opacity-70 dark:bg-opacity-100">
                <i class="eva eva-chevron-left-outline"></i>
            </span>
            <span>Prev</span>
        </a>
    </div><div class="hidden items-center text-xs xl:flex">
        Unless otherwise stated, this blog is licensed under 「
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" target="_blank" rel="noopener noreferrer" class="text-theme">CC BY-NC-SA 4.0</a>
        」
    </div>
    <div class="flex items-center text-sm xl:hidden">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" target="_blank" rel="noopener noreferrer" class="text-theme">
            <img src="/Cc-by-nc-sa.svg" alt="CC BY-NC-SA 4.0" title="CC BY-NC-SA 4.0" class="w-24" />
        </a>
    </div>

    <a
        href=""
        title=""
        class="invisible flex cursor-pointer items-center text-gray-500 transition duration-300 ease-[ease] hover:text-theme dark:text-darkTextPlaceholder dark:hover:text-darkText">
        <span>Next</span>
        <span class="flex items-center text-5xl opacity-70 dark:bg-opacity-100">
            <i class="eva eva-chevron-right-outline"></i>
        </span>
    </a>
</div>


        </div>
    </div>
</div>

</div>
                </main><footer>
    <div
        class="com-footer flex flex-col items-center border-t py-4 px-4 text-sm leading-none text-gray-600 dark:border-darkBorder dark:text-darkTextPlaceholder md:flex-row md:justify-between"
    >
        <div class="mb-2 flex items-center justify-between text-center md:mb-0">
            <span class="">© 2022 - 2023</span>
            <span class="mx-1.5 opacity-50"> | </span>Powered by <a data-no-swup class="mx-1 font-bold hover:text-theme" href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> <span class="text-xs opacity-70">❤</span> <a data-no-swup class="mx-1 font-bold hover:text-theme" href="https://github.com/Ice-Hazymoon/hugo-theme-luna" target="_blank" rel="noopener noreferrer">Luna</a></div>

        <div class="flex items-center"><span class="noscript-hidden mx-1.5 hidden opacity-50 md:block"> | </span><a data-no-swup href="https://rjtk.github.io/index.xml" target="_blank" class="mr-1.5 hover:text-theme">
                    <span class=" md:hidden lg:inline"><svg t="1650887361919" class="mr-0.5 w-3 fill-current text-inherit inline-block align-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3091"><path d="M320.16155 831.918c0 70.738-57.344 128.082-128.082 128.082S63.99955 902.656 63.99955 831.918s57.344-128.082 128.082-128.082 128.08 57.346 128.08 128.082z m351.32 94.5c-16.708-309.2-264.37-557.174-573.9-573.9C79.31155 351.53 63.99955 366.21 63.99955 384.506v96.138c0 16.83 12.98 30.944 29.774 32.036 223.664 14.568 402.946 193.404 417.544 417.544 1.094 16.794 15.208 29.774 32.036 29.774h96.138c18.298 0.002 32.978-15.31 31.99-33.58z m288.498 0.576C943.19155 459.354 566.92955 80.89 97.00555 64.02 78.94555 63.372 63.99955 77.962 63.99955 96.032v96.136c0 17.25 13.67 31.29 30.906 31.998 382.358 15.678 689.254 322.632 704.93 704.93 0.706 17.236 14.746 30.906 31.998 30.906h96.136c18.068-0.002 32.658-14.948 32.01-33.008z" p-id="3092"></path></svg></span>
                    <span>RSS</span>
                </a><a data-no-swup href="https://rjtk.github.io/sitemap.xml" target="_blank" class="mr-1.5 hover:text-theme">
                    <span class=" md:hidden lg:inline"><svg t="1650887940556" class="mr-0.5 w-3 fill-current text-inherit inline-block align-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6291"><path d="M950.044 625.778h-68.266v-56.89c0-45.51-39.822-85.332-85.334-85.332h-256v-85.334h68.267c39.822 0 73.956-34.133 73.956-73.955V130.844c0-39.822-34.134-73.955-73.956-73.955H415.29c-39.822 0-73.956 34.133-73.956 73.955v193.423c0 39.822 34.134 73.955 73.956 73.955h68.267v85.334h-256c-45.512 0-85.334 39.822-85.334 85.333v56.889H73.956C34.133 625.778 0 659.91 0 699.733v193.423c0 39.822 34.133 73.955 73.956 73.955h193.422c39.822 0 73.955-34.133 73.955-73.955V699.733c0-39.822-34.133-73.955-73.955-73.955H199.11v-56.89c0-17.066 11.378-28.444 28.445-28.444h568.888c17.067 0 28.445 11.378 28.445 28.445v56.889h-68.267c-39.822 0-73.955 34.133-73.955 73.955v193.423c0 39.822 34.133 73.955 73.955 73.955h193.422c39.823 0 73.956-34.133 73.956-73.955V699.733c0-39.822-34.133-73.955-73.956-73.955z" p-id="6292"></path></svg></span>
                    <span>Sitemap</span>
                </a></div><div id="run-time" class="mt-2 flex-grow text-right md:mt-0">
    <span>Run time: </span><b id="run-time-d">0</b>
    <span class="text-xs">days</span>
    <b id="run-time-h">0</b>
    <span class="text-xs">h</span>
    <b id="run-time-m">0</b>
    <span class="text-xs">m</span>
    <b id="run-time-s">0</b>
    <span class="text-xs">s</span>
</div>
</div>

    <script type="text/javascript">
window.__theme = {
    cdn: '',
    pjax: true ,
    isServer: false ,
    $version:"",
    lang: 'en-us',
    imageZoom: true ,
    lazyload: true ,
    bionicReading: {
        enabled: true ,
        skipLinks: false ,
        autoBionic: false ,
        excludeWords:[],
        excludeClasses:[],
        excludeNodeNames:[],
    },
    katex: true ,
    search: true ,
    backtop: true ,
    pangu: false ,
    autoDarkMode: false ,
    googleAnalytics:false,
    hugoEncrypt: {
        wrongPasswordText: 'Password is incorrect',
        userStorage:window['sessionStorage'],
    },
    console: {
        enabled: true ,
        leftColor: '#dd6065',
        rightColor: '#feb462',
        leftText: 'Hugo Theme Luna',
        rightText: 'Powered by Hugo ❤ Luna',
    },
    assets: {
        error_svg: "\/images\/error.svg",
        search_svg: "\/images\/search.svg",
    },
    i18n: {
        copy: {
            success: "Copy success",
            failed: "Copy failed",
            copyCode: "Copy code",
        },
        search: {
            untitled: "Untitled",
            loadFailure: "Initialization of the search engine failed",
            input: "Type something...",
        },
        darkMode: {
            dark: "Switch to dark mode",
            light: "Switch to light mode"
        }
    },creatTime: "2022\/12\/11"}
</script>
<script type="text/javascript" src="/ts/main.3e551c0bbea8d18cea412abc67113efa9fd16c3bba1eb4867a7e762260ee32dc.js" defer integrity="sha256-PlUcC76o0YzqQSq8ZxE&#43;&#43;p/RbDu6HrSGen52ImDuMtw="></script>





<script>
    
    
</script>

<script data-swup-reload-script>
    
    
</script>
</footer>
</div>
        </div><a
        href="#nav"
        title="Back to top"
        id="back-top"
        class="fixed right-6 bottom-9 z-10 translate-y-3 scale-90 cursor-pointer rounded-full bg-white opacity-0 transition duration-300 ease-[ease] dark:bg-darkBgAccent sm:scale-100"
    >
        <div class="relative">
            <div class="absolute left-0 top-0 flex h-full w-full items-center justify-center text-xl">
                <i class="eva eva-arrow-upward-outline"></i>
            </div>
            <svg id="svg" width="54" height="54" viewBox="0 0 54 54" preserveAspectRatio="xMinYMin meet">
                <circle
                    transform="rotate(-90, 27 , 27)"
                    style="stroke-dasharray: 157, 157; stroke-dashoffset: 157;"
                    cx="27"
                    cy="27"
                    r="25"
                    fill="none"
                    stroke-width="4"
                    stroke-linecap="round"
                    stroke="var(--theme)"
                />
            </svg>
        </div>
    </a><noscript>
    <style>
        .dark-mode-switch,
        #run-time,
        #bionicReading,
        .noscript-hidden,
        [data-clipboard-text],
        [data-lazyload] {
            display: none;
        }
        #back-top {
            opacity: 1;
        }
        .noscript-show {
            display: initial;
        }
    </style>
</noscript>
</body>
</html>
